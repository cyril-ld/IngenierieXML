<?php header('Content-type: text/xml');include_once('Sax4PHP.php');class Utils{ public static function getDistance($lat1,$lon1,$lat2,$lon2){$rLat1=deg2rad($lat1);$rLon1=deg2rad($lon1);$rLat2=deg2rad($lat2);$rLon2=deg2rad($lon2);$x=($rLon2-$rLon1)*cos(($rLat1+$rLat2)/2);$y=$rLat2-$rLat1;$dist=sqrt($x*$x+$y*$y)*6371009;return $dist;}}class EquiMobi{ private $nom; private $categorie; private $adresse; private $latitude; private $longitude; public function setLongitude($longitude){$this->longitude=$longitude;} public function getLongitude(){return $this->longitude;} public function setLatitude($latitude){$this->latitude=$latitude;} public function getLatitude(){return $this->latitude;} public function setNom($nom){$this->nom=$nom;} public function getNom(){return $this->nom;} public function setCategorie($categorie){$this->categorie=$categorie;} public function getCategorie(){return $this->categorie;} public function setAdresse($adresse){$this->adresse=$adresse;} public function getAdresse(){return $this->adresse;}}class EquiSport{ private $nom; private $adresse; private $equipements; private $distanceMax; private $latitude; private $longitude;function __construct(){}function __destruct(){} public function EquiSport($nom,$prenom,$distanceMax){$this->nom=$nom;$this->adresse=$adresse;$this->distanceMax=$distanceMax;$this->$equipements=array();} public function setLongitude($longitude){$this->longitude=$longitude;} public function getLongitude(){return $this->longitude;} public function setLatitude($latitude){$this->latitude=$latitude;} public function getLatitude(){return $this->latitude;} public function setNom($nom){$this->nom=$nom;} public function getNom(){return $this->nom;} public function setAdresse($adresse){$this->adresse=$adresse;} public function getAdresse(){return $this->adresse;} public function addEquipement($equipement){array_push($this->equipements,$equipement);} public function setDistanceMax($distance){$this->distanceMax=$distance;} public function getDistanceMax(){return $this->distanceMax;} public function getEquipements(){return $this->equipements;}}class SportHandler extends DefaultHandler{ private $listeEquipements; private $texte; private $equiSportCourant; private $latitude; private $longitude; private $liste_equipements_sportifs;function __construct($new_liste_equipements_sportifs){$this->liste_equipements_sportifs=$new_liste_equipements_sportifs;parent::__construct();}function startElement($name,$att){$this->texte='';switch(utf8_decode($name)){case 'element':$this->equiSportCourant=new EquiSport();break;default:break;}}function endElement($name){switch(utf8_decode($name)){case 'element':array_push($this->liste_equipements_sportifs,$this->equiSportCourant);$this->equiSportCourant=null;break;case 'name':if(strlen($this->texte)>0){$this->equiSportCourant->setNom(utf8_decode($this->texte));}break;case 'ADRESSE':if(strlen($this->texte)>0){$this->equiSportCourant->setAdresse(utf8_decode($this->texte)." ".$this->equiSportCourant->getAdresse());}break;case 'CODE_POSTAL':if(strlen($this->texte)>0){$this->equiSportCourant->setAdresse($this->equiSportCourant->getAdresse()." ".utf8_decode($this->texte));}break;case 'COMMUNE':if(strlen($this->texte)>0){$this->equiSportCourant->setAdresse($this->equiSportCourant->getAdresse()." ".utf8_decode($this->texte));}break;case '_l':$caracteres=array("[","]"," ");$latlon=str_replace($caracteres,"",utf8_decode($this->texte));$latLonTab=explode(",",$latlon);$this->equiSportCourant->setLatitude($latLonTab[0]);$this->equiSportCourant->setLongitude($latLonTab[1]);break;default:break;}}function startDocument(){echo "<liste-equisport>\n";}function endDocument(){foreach($this->liste_equipements_sportifs as $value){echo '<equisport nom="'.utf8_encode($value->getNom()).'" adresse="'.utf8_encode($value->getAdresse()).'">';$liste_equipements_mobilite=$value->getEquipements();if(count($liste_equipements_mobilite)==0){echo '<mobi-proxy/>';}else {echo '<mobi-proxy>';foreach($liste_equipements_mobilite as $equiMobi){echo '<nom>'.$equiMobi->getNom().'</nom>';echo '<categorie>'.$equiMobi->getCategorie().'</categorie>';echo '<adresse>'.$equiMobi->getAdresse().'</adresse>';echo '<distance/>';}echo '</mobi-proxy>';}echo '</equisport>';}echo "</liste-equisport>\n";}function characters($txt){$txt_reduit=trim($txt);if(!(empty($txt_reduit)))$this->texte.=$txt;}function setListeEquipementsMobilite(){$xmlMobilite=file_get_contents('../LOC_EQUIPUB_MOBILITE_NM_STBL.xml');$this->equiSportCourant->setDistanceMax(500);$saxMobilite=new SaxParser(new MobiliteHandler($equiSportCourant));}}class MobiliteHandler extends DefaultHandler{ private $equipementSport; private $equiMobiCourant; private $texte;function __construct($equipementSport){echo 'Constructeur !';$this->equipementSport=$equipementSport;parent::__construct();}function startElement($name,$att){echo 'start element';$this->texte='';switch($name){case 'element':$this->$equiMobiCourant=new EquiMobi();break;default:break;}}function endElement($name){switch($name){case 'element':$distance=getDistance($this->equiMobiCourant->getLatitude(),$this->equiMobiCourant->getLongitude(),$this->equipementSport->getLatitude(),$this->equipementSport->getLongitude());echo "Je suis l'élément de fin d'un équipement de mobilité, à ".$distance."m de l'équipement sportif !";if($distance<500){$this->equipementSport->addEquipement($this->equiMobiCourant);}$this->equiMobiCourant=null;break;case 'name':$this->equiMobiCourant->setNom(utf8_decode($this->texte));break;case '_l':$caracteres=array("[","]"," ");$latlon=str_replace($caracteres,"",utf8_decode($this->texte));$latLonTab=explode(",",$latlon);$this->equiMobiCourant->setLatitude($latLonTab[0]);$this->equiMobiCourant->setLongitude($latLonTab[1]);case 'LIBCATEGORIE':$this->equiMobiCourant->setCategorie(utf8_decode($this->texte));break;case 'ADRESSE':$this->equiMobiCourant->setAdresse(utf8_decode($this->texte));break;default:break;}}function startDocument(){$rien;}function endDocument(){$rien;}function characters($txt){$txt_reduit=trim($txt);if(!(empty($txt_reduit)))$this->texte.=$txt;}}$xmlSport=file_get_contents('../LOC_EQUIPUB_SPORT_NM_STBL.xml');echo "<?xml version='1.0' encoding='UTF-8'?>";if(is_null($xmlSport)){echo "rien dans le xml de sport !";}$liste_equipements_sportifs=array();$saxSport=new SaxParser(new SportHandler($liste_equipements_sportifs));try{$saxSport->parse($xmlSport);}catch(SAXException$e){echo "\n",$e;}catch(Exception$e){echo "Default exception >>",$e;}?>
